;-------------------------------------------------------------;- SyncIt!;- small tool to synchronize two directories;- include file: check_dir.pbi;- Copyright 2020 by Markus Mueller <markus.mueller.73 at hotmail dot de>;- This program is free software;-------------------------------------------------------------;-------------------------------------------------------------;-specific constantsEnumerationBinary Differences     #APP_FILEATTR_EQUAL    #APP_FILEATTR_EQUAL_DATE    #APP_FILEATTR_EQUAL_SIZE    #APP_FILEATTR_SRC_NOT_EXIST    #APP_FILEATTR_DST_NOT_EXIST    #APP_FILEATTR_SRC_IS_NEWER    #APP_FILEATTR_SRC_IS_OLDER    #APP_FILEATTR_SRC_IS_BIGGER    #APP_FILEATTR_SRC_IS_SMALLEREndEnumerationCompilerIf #PB_Compiler_OS = #PB_OS_Linux Or #PB_Compiler_OS = #PB_OS_MacOS  #PB_FileSystem_Hidden = %10000000000000CompilerEndIf;-------------------------------------------------------------;-specific structuresStructure _FILE_DATES  CompilerIf #PB_Compiler_OS = #PB_OS_Windows    created.l  CompilerEndIf  modified.l  accessed.lEndStructureStructure _FILE_DATES_EX  src._FILE_DATES  dst._FILE_DATESEndStructureStructure _PATHS  src.s  dst.sEndStructureStructure _SIZES  src.q  dst.qEndStructureStructure _FILE_DESCRIPTOR  attr.l            ; = file system attributes  date._FILE_DATES    diff.l            ; = internal attributes (differences)  size.q            ; = file size in bytes  name.s  path.s            ; with trailing path separatorEndStructureStructure _FILE_DESCRIPTOR_EX  attr.l              ; = file system attributes from the source file  date._FILE_DATES_EX  diff.l              ; = internal attributes (differences)  size._SIZES         ; = file size in bytes  name.s  path._PATHS         ; with trailing path separator  sync_status.l       ; set with CopyStatus constants  ;to_copy.b           ; = TRUE if this file is to synchronize  ;to_del.b            ; = TRUE if this file is to deleteEndStructure;-------------------------------------------------------------;-helper macrosMacro _CHECK_SLASH( directory )  If Right(directory, 1) <> #PS$    directory + #PS$  EndIfEndMacroMacro _GET_REL_PATH( llist , root_dir )    RemoveString(llist\path + llist\name, root_dir, #APP_STRING_CASE, 1, 1)EndMacro;-------------------------------------------------------------;-helper functionsProcedure.i get_directory_content( root_dir$ , List files._FILE_DESCRIPTOR() )    Protected.i dir_h, nb_of_files, tmp_attr  Protected.s new_dir    If FileSize(root_dir$) <> -2    warn("Directory '" + root_dir$ + "' did not exist.")    ProcedureReturn 0  EndIf    _check_slash(root_dir$)    dir_h = ExamineDirectory(#PB_Any, root_dir$, #APP_SEARCH_PATTERN)  If IsDirectory(dir_h)        info("Checking directory '" + root_dir$ + "' now.")        While NextDirectoryEntry(dir_h)            If DirectoryEntryType(dir_h) = #PB_DirectoryEntry_Directory                new_dir = DirectoryEntryName(dir_h)        If new_dir <> "." And new_dir <> ".."          nb_of_files + get_directory_content(root_dir$ + new_dir, files())        EndIf              ElseIf DirectoryEntryType(dir_h) = #PB_DirectoryEntry_File                AddElement(files())        files()\path          = root_dir$        files()\name          = DirectoryEntryName(dir_h)        files()\size          = DirectoryEntrySize(dir_h)        files()\attr          = DirectoryEntryAttributes(dir_h)        files()\date\accessed = DirectoryEntryDate(dir_h, #PB_Date_Accessed)        files()\date\modified = DirectoryEntryDate(dir_h, #PB_Date_Modified)        CompilerIf #PB_Compiler_OS = #PB_OS_Windows          files()\date\created  = DirectoryEntryDate(dir_h, #PB_Date_Created)        CompilerElse          If Left(files()\name, 1) = #DOT$            files()\attr = #PB_FileSystem_Hidden | files()\attr          EndIf        CompilerEndIf                nb_of_files + 1              EndIf          Wend        FinishDirectory(dir_h)        info("Finished directory '" + root_dir$ + "', found " + Str(nb_of_files) + " files.")      Else    warn("Can't access directory '" + root_dir$ + "'.")    ProcedureReturn 0  EndIf    ProcedureReturn nb_of_files  EndProcedureProcedure.i compare_directories ( src_root_dir$, List src_dir._FILE_DESCRIPTOR() , dst_root_dir$, List dst_dir._FILE_DESCRIPTOR() , List result._FILE_DESCRIPTOR_EX() )    info("comparing directories '" + src_root_dir$ + "' and '" + dst_root_dir$ + "'")    If ListSize(src_dir()) = 0    ProcedureReturn 0  EndIf    If ListSize(result()) > 0    ClearList(result())  EndIf      If ListSize(dst_dir()) = 0        info("destination dir '" + dst_root_dir$ + "' is empty.")    EndIf    Protected.b dst_not_found  Protected.f progress, one_perc = ListSize(src_dir()) / 100  Protected.s src_rel_path, dst_rel_path    _CHECK_SLASH(src_root_dir$)  _CHECK_SLASH(dst_root_dir$)    info("checking source directory")  ForEach src_dir()        progress = ListIndex(src_dir()) / one_perc        dst_not_found = #True    src_rel_path = _GET_REL_PATH(src_dir(), src_root_dir$)        ForEach dst_dir()            dst_rel_path = _GET_REL_PATH(dst_dir(), dst_root_dir$)            If CompareMemoryString(@src_rel_path, @dst_rel_path, #APP_STRING_CASE) = #PB_String_Equal                dst_not_found = #False                AddElement(result())                result()\path\src           = src_dir()\path        result()\path\dst           = dst_dir()\path        result()\name               = src_dir()\name        result()\attr               = src_dir()\attr        result()\date\src\modified  = src_dir()\date\modified        result()\date\src\accessed  = src_dir()\date\accessed        result()\date\dst\modified  = dst_dir()\date\modified        result()\date\dst\accessed  = dst_dir()\date\accessed        result()\size\src           = src_dir()\size        result()\size\dst           = dst_dir()\size                If src_dir()\size > dst_dir()\size            result()\diff | #APP_FILEATTR_SRC_IS_BIGGER        ElseIf src_dir()\size < dst_dir()\size            result()\diff | #APP_FILEATTR_SRC_IS_SMALLER        Else            result()\diff | #APP_FILEATTR_EQUAL_SIZE        EndIf                If src_dir()\date\modified > dst_dir()\date\modified            result()\diff | #APP_FILEATTR_SRC_IS_NEWER        ElseIf src_dir()\date\modified < dst_dir()\date\modified            result()\diff | #APP_FILEATTR_SRC_IS_OLDER        Else            result()\diff | #APP_FILEATTR_EQUAL_DATE        EndIf                If result()\diff & #APP_FILEATTR_EQUAL_SIZE And result()\diff & #APP_FILEATTR_EQUAL_DATE            result()\diff | #APP_FILEATTR_EQUAL        EndIf                DeleteElement(dst_dir(), 1)        Break              EndIf          Next        If dst_not_found                AddElement(result())                result()\path\src = src_dir()\path        result()\path\dst = dst_root_dir$ + RemoveString(src_dir()\path, src_root_dir$, #APP_STRING_CASE, 1, 1)        result()\name     = src_dir()\name        result()\attr     = src_dir()\attr                result()\diff | #APP_FILEATTR_DST_NOT_EXIST            EndIf      Next    info("compare of source and destination directory done")    If ListSize(dst_dir()) > 0          info("found " + Str(ListSize(dst_dir())) + " more files in destination directory")          ForEach dst_dir()                AddElement(result())                result()\path\src = src_root_dir$ + RemoveString(dst_dir()\path, dst_root_dir$, #APP_STRING_CASE, 1, 1)        result()\path\dst = dst_dir()\path        result()\name     = dst_dir()\name        result()\attr     = dst_dir()\attr                result()\diff | #APP_FILEATTR_SRC_NOT_EXIST            Next    EndIf    ClearList(src_dir())  ClearList(dst_dir())    info("compare operation complete, found " + Str(ListSize(result())) + " differences")  ProcedureReturn ListSize(result())  EndProcedure; IDE Options = PureBasic 6.04 LTS (Windows - x64); CursorPosition = 67; FirstLine = 39; Folding = --; Optimizer; EnableXP; EnablePurifier; EnableCompileCount = 0; EnableBuildCount = 0; EnableExeConstant